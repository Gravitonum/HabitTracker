# ROADMAP - Доработка функционала челленджей и друзей

## Обзор проекта
Проект представляет собой Telegram-бота для отслеживания привычек с элементами геймификации. В базе данных уже существуют модели для челленджей, участников челленджей и друзей. Требуется доработать функционал для создания ежедневных и недельных челленджей, добавления друзей в челленджи и отображения лидеров по очкам среди друзей.

## Текущее состояние
- ✅ Базовая архитектура бота
- ✅ Модели базы данных (Challenge, ChallengeParticipant, Friend)
- ✅ Система привычек и их отслеживания
- ✅ Геймификация (очки, уровни, награды)
- ✅ Планировщик напоминаний

## План доработки

### Этап 1: Сервисы для работы с друзьями (1-2 дня)

#### 1.1 Создание сервиса друзей
**Файл:** `app/bot/services/friend_service.py`

**Функции:**
- `send_friend_request(telegram_id, friend_telegram_id)` - отправить запрос в друзья
- `accept_friend_request(request_id)` - принять запрос в друзья
- `reject_friend_request(request_id)` - отклонить запрос в друзья
- `get_friend_requests(telegram_id)` - получить входящие запросы
- `get_friends(telegram_id)` - получить список друзей
- `remove_friend(telegram_id, friend_telegram_id)` - удалить из друзей
- `get_friends_by_telegram_id(telegram_id)` - получить друзей по telegram_id

#### 1.2 Обновление схем Pydantic
**Файл:** `app/models/schemas.py`

**Добавить схемы:**
- `FriendRequestResponse` - для ответа на запрос в друзья
- `FriendListResponse` - для отображения списка друзей
- `FriendLeaderboard` - для таблицы лидеров среди друзей

### Этап 2: Сервисы для работы с челленджами (2-3 дня)

#### 2.1 Создание сервиса челленджей
**Файл:** `app/bot/services/challenge_service.py`

**Функции:**
- `create_daily_challenge(name, description, points_reward, badge_reward)` - создать ежедневный челлендж
- `create_weekly_challenge(name, description, points_reward, badge_reward)` - создать недельный челлендж
- `join_challenge(challenge_id, user_telegram_id)` - присоединиться к челленджу
- `leave_challenge(challenge_id, user_telegram_id)` - покинуть челлендж
- `invite_friends_to_challenge(challenge_id, user_telegram_id, friend_telegram_ids)` - пригласить друзей
- `get_active_challenges()` - получить активные челленджи
- `get_user_challenges(telegram_id)` - получить челленджи пользователя
- `get_challenge_participants(challenge_id)` - получить участников челленджа
- `update_challenge_progress(challenge_id, user_telegram_id, progress)` - обновить прогресс
- `complete_challenge(challenge_id, user_telegram_id)` - завершить челлендж
- `get_challenge_leaderboard(challenge_id)` - получить таблицу лидеров челленджа

#### 2.2 Обновление схем Pydantic
**Файл:** `app/models/schemas.py`

**Добавить схемы:**
- `ChallengeCreateRequest` - для создания челленджа
- `ChallengeJoinRequest` - для присоединения к челленджу
- `ChallengeProgress` - для отслеживания прогресса
- `ChallengeLeaderboard` - для таблицы лидеров челленджа
- `ChallengeInvite` - для приглашения друзей

### Этап 3: Обработчики команд для друзей (1-2 дня)

#### 3.1 Создание обработчика друзей
**Файл:** `app/bot/handlers/friends.py`

**Команды:**
- `/add_friend <telegram_id>` - добавить друга по ID
- `/friend_requests` - показать входящие запросы
- `/friends` - показать список друзей
- `/remove_friend <telegram_id>` - удалить друга
- `/friends_leaderboard` - показать лидеров среди друзей

**Callback обработчики:**
- `handle_accept_friend_request` - принять запрос
- `handle_reject_friend_request` - отклонить запрос
- `handle_remove_friend` - удалить друга

### Этап 4: Обработчики команд для челленджей (2-3 дня)

#### 4.1 Создание обработчика челленджей
**Файл:** `app/bot/handlers/challenges.py`

**Команды:**
- `/create_challenge` - создать челлендж (интерактивно)
- `/join_challenge <challenge_id>` - присоединиться к челленджу
- `/my_challenges` - показать мои челленджи
- `/challenge_leaderboard <challenge_id>` - показать лидеров челленджа
- `/invite_friends <challenge_id>` - пригласить друзей в челлендж

**Callback обработчики:**
- `handle_join_challenge` - присоединиться к челленджу
- `handle_leave_challenge` - покинуть челлендж
- `handle_invite_friends` - пригласить друзей
- `handle_challenge_type_selection` - выбор типа челленджа

#### 4.2 Создание интерактивного диалога создания челленджа
**Файл:** `app/bot/handlers/challenge_conversation.py`

**Состояния диалога:**
- `CHALLENGE_TYPE` - выбор типа челленджа (ежедневный/недельный)
- `CHALLENGE_NAME` - ввод названия
- `CHALLENGE_DESCRIPTION` - ввод описания
- `CHALLENGE_REWARDS` - настройка наград
- `CHALLENGE_FRIENDS` - выбор друзей для приглашения

### Этап 5: Обновление основного файла бота (1 день)

#### 5.1 Интеграция новых обработчиков
**Файл:** `app/main.py`

**Изменения:**
- Добавить импорты новых обработчиков
- Зарегистрировать новые команды
- Добавить ConversationHandler для создания челленджей
- Обновить команды бота в меню

### Этап 6: Обновление системы наград (1 день)

#### 6.1 Расширение системы наград для челленджей
**Файл:** `app/bot/services/reward_service.py`

**Новые функции:**
- `award_challenge_completion(challenge_id, user_telegram_id)` - награда за завершение челленджа
- `award_challenge_leaderboard_position(challenge_id, user_telegram_id, position)` - награда за место в лидерборде
- `get_challenge_rewards(telegram_id)` - получить награды за челленджи

### Этап 7: Обновление планировщика (1 день)

#### 7.1 Добавление уведомлений о челленджах
**Файл:** `app/core/scheduler.py`

**Новые функции:**
- `send_challenge_reminders()` - напоминания о челленджах
- `send_challenge_deadline_warnings()` - предупреждения о дедлайнах
- `send_challenge_completion_notifications()` - уведомления о завершении

### Этап 8: Тестирование и отладка (2-3 дня)

#### 8.1 Создание тестовых данных
**Файл:** `test_data.py`

**Функции:**
- Создание тестовых пользователей
- Создание тестовых челленджей
- Создание тестовых дружеских связей

#### 8.2 Тестирование функционала
- Тестирование добавления друзей
- Тестирование создания челленджей
- Тестирование присоединения к челленджам
- Тестирование системы лидеров
- Тестирование уведомлений

### Этап 9: Документация и финальная настройка (1 день)

#### 9.1 Обновление документации
**Файлы:**
- `README.md` - обновить описание функционала
- `DEPLOYMENT.md` - добавить инструкции по развертыванию
- `Архитектура проекта.md` - обновить схему архитектуры

#### 9.2 Финальная настройка
- Обновление команд бота в меню
- Настройка логирования для новых функций
- Оптимизация производительности

## Детальное описание новых функций

### Система друзей

#### Добавление друга
1. Пользователь вводит `/add_friend <telegram_id>`
2. Система проверяет существование пользователя с указанным ID
3. Создается запрос в друзья со статусом "pending"
4. Отправляется уведомление целевому пользователю
5. Целевой пользователь может принять или отклонить запрос

#### Управление друзьями
- Просмотр списка друзей с их статистикой
- Удаление друзей
- Просмотр входящих запросов в друзья

### Система челленджей

#### Создание челленджа
1. Пользователь выбирает тип челленджа (ежедневный/недельный)
2. Вводит название и описание
3. Настраивает награды (очки, бейдж)
4. Выбирает друзей для приглашения
5. Челлендж создается и участники получают уведомления

#### Участие в челлендже
- Присоединение к челленджу по ID
- Отслеживание прогресса
- Просмотр лидеров челленджа
- Получение наград за завершение

### Система лидеров

#### Лидеры среди друзей
- Сортировка друзей по очкам
- Отображение позиции пользователя
- Обновление в реальном времени

#### Лидеры челленджа
- Сортировка участников по прогрессу
- Отображение текущего места
- Награды за высокие позиции

## Технические требования

### База данных
- Использование существующих таблиц Challenge, ChallengeParticipant, Friend
- Добавление индексов для оптимизации запросов
- Миграции для обновления схемы (если необходимо)

### Производительность
- Кэширование часто запрашиваемых данных
- Оптимизация SQL запросов
- Асинхронная обработка уведомлений

### Безопасность
- Валидация входных данных
- Проверка прав доступа
- Защита от спама и злоупотреблений

## Временные рамки

**Общее время разработки: 10-15 дней**

- Этап 1-2: 3-5 дней (сервисы)
- Этап 3-4: 3-5 дней (обработчики)
- Этап 5-7: 3 дня (интеграция)
- Этап 8-9: 2-3 дня (тестирование и документация)

## Приоритеты

1. **Высокий приоритет:** Система друзей, создание челленджей
2. **Средний приоритет:** Участие в челленджах, лидеры
3. **Низкий приоритет:** Дополнительные уведомления, расширенная аналитика

## Риски и митигация

### Риски
- Сложность интеграции с существующей системой
- Производительность при большом количестве участников
- Сложность UX для управления друзьями и челленджами

### Митигация
- Поэтапная разработка с тестированием
- Оптимизация запросов к базе данных
- Простой и интуитивный интерфейс команд
