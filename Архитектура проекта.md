# Архитектура проекта HabitTracker

## Обзор
Telegram-бот для отслеживания привычек с системой геймификации, написанный на Python с использованием FastAPI, SQLAlchemy и python-telegram-bot.

## Структура проекта

```
HabitTracker/
├── app/
│   ├── bot/                    # Telegram Bot логика
│   │   ├── handlers/           # Обработчики команд
│   │   │   ├── habits.py       # Команды для работы с привычками
│   │   │   └── conversation.py # Интерактивные диалоги
│   │   └── services/           # Бизнес-логика
│   │       ├── habit_service.py    # Сервис привычек
│   │       ├── user_service.py     # Сервис пользователей
│   │       └── reward_service.py   # Система наград
│   ├── core/                   # Основные компоненты
│   │   ├── config.py           # Конфигурация
│   │   ├── database.py         # Подключение к БД
│   │   └── scheduler.py        # Планировщик задач
│   ├── models/                 # Модели данных
│   │   ├── database.py         # SQLAlchemy модели
│   │   └── schemas.py          # Pydantic схемы
│   ├── utils/                  # Утилиты
│   │   ├── points_calculator.py    # Расчет очков
│   │   └── streak_calculator.py    # Расчет серий
│   └── main.py                 # Точка входа
├── habits_tracker.db           # SQLite база данных
├── requirements.txt            # Зависимости
└── start_bot.py               # Скрипт запуска
```

## Основные компоненты

### 1. Telegram Bot (app/bot/)
- **handlers/habits.py** - Основные команды бота
  - `/habits` - Список привычек
  - `/create_habit` - Создание привычки (интерактивно)
  - `/complete` - Отметка выполнения
  - `/delete_habit` - Удаление привычки
  - `/stats` - Статистика
- **handlers/conversation.py** - Интерактивные диалоги
  - Создание привычки через ConversationHandler
  - Выбор типа расписания
  - Настройка custom расписания

### 2. Сервисы (app/bot/services/)
- **habit_service.py** - Управление привычками
  - Создание, получение, удаление привычек
  - Отметка выполнения
  - Расчет статистики
- **user_service.py** - Управление пользователями
  - Регистрация и обновление пользователей
  - Управление очками и сериями
- **reward_service.py** - Система наград
  - Начисление очков
  - Проверка достижений
  - Управление уровнями

### 3. Модели данных (app/models/)
- **database.py** - SQLAlchemy модели
  - `User` - Пользователи
  - `Habit` - Привычки
  - `HabitCompletion` - Выполнения привычек
  - `ScheduleType` - Типы расписания
  - `Reward` - Награды
- **schemas.py** - Pydantic схемы для валидации

### 4. Планировщик (app/core/scheduler.py)
- Отправка ежедневных напоминаний
- Фоновые задачи
- Интеграция с APScheduler

## База данных

### Основные таблицы:
- **User** - Пользователи (telegram_id, username, level, points, streaks)
- **Habit** - Привычки (name, description, schedule_type, custom_settings)
- **HabitCompletion** - Выполнения (habit_id, user_id, date, points)
- **ScheduleType** - Типы расписания (daily, weekly, custom)
- **Reward** - Награды пользователей

### Связи:
- User 1:N Habit
- User 1:N HabitCompletion
- Habit 1:N HabitCompletion
- Habit N:1 ScheduleType

## Типы расписания

1. **Daily (Ежедневно)** - Напоминания каждый день
2. **Weekly (Еженедельно)** - Напоминания раз в неделю
3. **Custom (Свой график)** - Настраиваемое расписание
   - Дни недели (пн,вт,ср,чт,пт,сб,вс)
   - Время напоминания (HH:MM)
   - Частота (каждый N день)

## Система геймификации

### Очки:
- Базовые очки за выполнение привычки
- Бонусы за серии (streak)
- Множители за сложность

### Серии (Streaks):
- Текущая серия выполнения
- Самая длинная серия
- Сброс при пропуске дня

### Уровни:
- Автоматическое повышение уровня
- Разблокировка новых возможностей

## API и интеграции

- **Telegram Bot API** - Основной интерфейс
- **SQLite** - Локальная база данных
- **APScheduler** - Планировщик задач
- **SQLAlchemy** - ORM для работы с БД
- **Pydantic** - Валидация данных

## Безопасность

- Валидация всех входящих данных
- Защита от SQL-инъекций через ORM
- Обработка ошибок и исключений
- Логирование всех операций

## Масштабируемость

- Модульная архитектура
- Разделение ответственности
- Легкое добавление новых команд
- Возможность замены БД
- Асинхронная обработка
